import{g as s,a8 as g,b as n}from"./BIQOLOFU.js";const y="cr_access_token",w="cr_refresh_token",S="cr_user";let a=g(null),d=g(null),h=g(null),_=g(!0),b=g(!1);function I(){try{const e=localStorage.getItem(y),t=localStorage.getItem(w),i=localStorage.getItem(S);e&&i&&(n(d,e,!0),n(h,t,!0),n(a,JSON.parse(i),!0))}catch(e){console.error("Failed to load auth state:",e),N()}n(_,!1),n(b,!0)}function K(e,t){n(a,e,!0),n(d,t.access_token,!0),n(h,t.refresh_token,!0),localStorage.setItem(y,t.access_token),localStorage.setItem(w,t.refresh_token),localStorage.setItem(S,JSON.stringify(e))}function L(e){n(a,e,!0),localStorage.setItem(S,JSON.stringify(e))}function m(e){n(d,e,!0),localStorage.setItem(y,e)}function N(){n(a,null),n(d,null),n(h,null),localStorage.removeItem(y),localStorage.removeItem(w),localStorage.removeItem(S)}function E(){return s(d)}function J(){return s(h)}function R(){return{get user(){return s(a)},get accessToken(){return s(d)},get refreshToken(){return s(h)},get isLoading(){return s(_)},get isInitialized(){return s(b)},get isAuthenticated(){return!!s(d)&&!!s(a)},get isAdmin(){var e;return((e=s(a))==null?void 0:e.role)==="admin"},get canEdit(){var e,t;return((e=s(a))==null?void 0:e.role)==="admin"||((t=s(a))==null?void 0:t.role)==="editor"}}}const f="/api";let T=!1,O=null;async function A(){const e=J();if(!e)return!1;try{const t=await fetch(`${f}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})});if(!t.ok)return!1;const i=await t.json();return m(i.access_token),!0}catch{return!1}}async function r(e,t,i=!1){const o={"Content-Type":"application/json",...t==null?void 0:t.headers},u=E();u&&!i&&(o.Authorization=`Bearer ${u}`);let c=await fetch(`${f}${e}`,{...t,headers:o});if(c.status===401&&!i){T||(T=!0,O=A());const k=await O;if(T=!1,O=null,k){const $=E();$&&(o.Authorization=`Bearer ${$}`),c=await fetch(`${f}${e}`,{...t,headers:o})}else throw N(),typeof window<"u"&&(window.location.href="/auth/login"),new Error("Session expired. Please log in again.")}if(!c.ok){const k=await c.json().catch(()=>({detail:"Request failed"}));throw new Error(k.detail||`HTTP ${c.status}`)}const P=await c.text();return P?JSON.parse(P):{}}async function l(e,t){return r(e,t,!0)}async function U(e,t){const i={},o=E();o&&(i.Authorization=`Bearer ${o}`);const u=await fetch(`${f}${e}`,{method:"POST",headers:i,body:t});if(!u.ok){const c=await u.json().catch(()=>({detail:"Upload failed"}));throw new Error(c.detail||`HTTP ${u.status}`)}return u.json()}const z={query:e=>r("/query",{method:"POST",body:JSON.stringify({text:e})}),getKnowledge:()=>r("/knowledge"),getKnowledgeById:e=>r(`/knowledge/${e}`),createKnowledge:e=>r("/ingest",{method:"POST",body:JSON.stringify(e)}),updateKnowledge:(e,t)=>r(`/knowledge/${e}`,{method:"PUT",body:JSON.stringify(t)}),deleteKnowledge:e=>r(`/knowledge/${e}`,{method:"DELETE"}),submitFeedback:e=>r("/feedback",{method:"POST",body:JSON.stringify(e)}),getEvents:()=>r("/events"),createEvent:e=>r("/events",{method:"POST",body:JSON.stringify(e)}),getAssets:()=>r("/assets"),createAsset:e=>r("/assets",{method:"POST",body:JSON.stringify(e)}),documents:{upload:(e,t)=>{const i=new FormData;return i.append("file",e),t!=null&&t.title&&i.append("title",t.title),t!=null&&t.description&&i.append("description",t.description),t!=null&&t.tags&&i.append("tags",t.tags),t!=null&&t.location&&i.append("location",t.location),t!=null&&t.hazard_type&&i.append("hazard_type",t.hazard_type),t!=null&&t.source&&i.append("source",t.source),U("/api/documents/upload",i)},getStatus:e=>r(`/api/documents/${e}/status`),getProcessingStats:()=>r("/api/documents/processing/stats")},knowledgeGraph:{getEntities:e=>{const t=new URLSearchParams;e!=null&&e.entity_type&&t.set("entity_type",e.entity_type),e!=null&&e.search&&t.set("search",e.search),e!=null&&e.limit&&t.set("limit",e.limit.toString()),e!=null&&e.offset&&t.set("offset",e.offset.toString());const i=t.toString();return r(`/api/kg/entities${i?`?${i}`:""}`)},getEntity:e=>r(`/api/kg/entities/${e}`),searchEntities:(e,t)=>{const i=new URLSearchParams({q:e});return t==null||t.forEach(o=>i.append("entity_types",o)),r(`/api/kg/entities/search?${i}`)},getStatistics:()=>r("/api/kg/statistics"),getCoverageGaps:(e,t,i)=>r(`/api/kg/coverage-gaps?entity_type=${e}&required_relationship=${t}&target_type=${i}`),getEntityNetwork:(e,t)=>r(`/api/kg/entities/${e}/network${t?`?max_depth=${t}`:""}`),createEntity:e=>r("/api/kg/entities",{method:"POST",body:JSON.stringify(e)}),updateEntity:(e,t)=>r(`/api/kg/entities/${e}`,{method:"PUT",body:JSON.stringify(t)}),deleteEntity:e=>r(`/api/kg/entities/${e}`,{method:"DELETE"}),getTypes:()=>r("/api/kg/types")},getHealth:()=>l("/health"),auth:{register:e=>l("/auth/register",{method:"POST",body:JSON.stringify(e)}),login:e=>l("/auth/login",{method:"POST",body:JSON.stringify(e)}),loginTotp:e=>l("/auth/login/totp",{method:"POST",body:JSON.stringify(e)}),setupTotp:()=>r("/auth/totp/setup",{method:"POST"}),verifyTotpSetup:e=>r("/auth/totp/verify-setup",{method:"POST",body:JSON.stringify({code:e})}),setPassword:e=>r("/auth/password",{method:"PUT",body:JSON.stringify(e)}),disableTotp:()=>r("/auth/totp",{method:"DELETE"}),getLoginUrl:e=>l(`/auth/login/${e}`),refresh:e=>l("/auth/refresh",{method:"POST",body:JSON.stringify({refresh_token:e})}),logout:e=>r("/auth/logout",{method:"POST",body:JSON.stringify({refresh_token:e})}),logoutAll:()=>r("/auth/logout-all",{method:"POST"}),getMe:()=>r("/auth/me"),updateMe:e=>r("/auth/me",{method:"PUT",body:JSON.stringify(e)}),getSessions:()=>r("/auth/me/sessions"),getApiKeys:()=>r("/auth/api-keys"),createApiKey:e=>r("/auth/api-keys",{method:"POST",body:JSON.stringify(e)}),revokeApiKey:e=>r(`/auth/api-keys/${e}`,{method:"DELETE"}),admin:{getUsers:e=>{const t=new URLSearchParams;e!=null&&e.skip&&t.set("skip",e.skip.toString()),e!=null&&e.limit&&t.set("limit",e.limit.toString()),(e==null?void 0:e.is_active)!==void 0&&t.set("is_active",e.is_active.toString()),e!=null&&e.role&&t.set("role",e.role);const i=t.toString();return r(`/auth/users${i?`?${i}`:""}`)},getUser:e=>r(`/auth/users/${e}`),updateUser:(e,t)=>r(`/auth/users/${e}`,{method:"PUT",body:JSON.stringify(t)}),deleteUser:e=>r(`/auth/users/${e}`,{method:"DELETE"})}}};export{z as a,J as b,N as c,R as g,I as i,K as s,L as u};
