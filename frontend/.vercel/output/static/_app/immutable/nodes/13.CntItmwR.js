import"../chunks/CWj6FrbW.js";import{o as Re}from"../chunks/DN4i8kDz.js";import{a3 as C,h as ce,j as de,aw as Ne,ax as Fe,u as ue,C as Le,O as Ie,ay as Ue,az as Ye,aA as ve,o as je,aB as ze,P as N,a1 as Be,a2 as Ge,ak as He,a4 as pe,g as s,a5 as w,a6 as Qe,b as a,e as Ve,a9 as i,a7 as o,a8 as A,W as P,aa as We,ad as Z,ac as l,af as k,ae as fe,ag as me,ai as Je}from"../chunks/BkQX6IBl.js";import{i as M}from"../chunks/CmSFReHR.js";import{h as Ke}from"../chunks/DN-AoazC.js";import{r as E,b as $}from"../chunks/TY_SEvFQ.js";import{b as F}from"../chunks/DE88cSuZ.js";import{g as Xe}from"../chunks/DjFSqXvx.js";import{a as O}from"../chunks/D4n-kpo8.js";import{g as Ze,u as ee}from"../chunks/DQ6qqwK7.js";import{s as $e,g as et}from"../chunks/DJgaem7h.js";function tt(L,I,v=!1,r=!1,d=!1){var m=L,g="";C(()=>{var p=Ne;if(g===(g=I()??"")){ce&&de();return}if(p.nodes!==null&&(Fe(p.nodes.start,p.nodes.end),p.nodes=null),g!==""){if(ce){ue.data;for(var c=de(),y=c;c!==null&&(c.nodeType!==Le||c.data!=="");)y=c,c=Ie(c);if(c===null)throw Ue(),Ye;ve(ue,y),m=je(c);return}var h=g+"";v?h=`<svg>${h}</svg>`:r&&(h=`<math>${h}</math>`);var u=ze(h);if((v||r)&&(u=N(u)),ve(N(u),u.lastChild),v||r)for(;N(u);)m.before(N(u));else m.before(u)}})}var at=A('<div class="message error-message svelte-1i19ct2"> </div>'),st=A('<div class="message success-message svelte-1i19ct2"> </div>'),rt=A('<label for="current-password" class="svelte-1i19ct2">Current password</label> <input id="current-password" type="password" required autocomplete="current-password" class="svelte-1i19ct2"/>',1),it=A(`<div class="totp-setup svelte-1i19ct2"><p class="svelte-1i19ct2">Scan this QR code with your authenticator app (Google Authenticator, Microsoft Authenticator, Authy, etc.):</p> <div class="qr-code svelte-1i19ct2"><!></div> <details class="manual-entry svelte-1i19ct2"><summary class="svelte-1i19ct2">Can't scan? Enter this key manually</summary> <code class="secret-key svelte-1i19ct2"> </code></details> <form class="verify-form svelte-1i19ct2"><label for="totp-verify" class="svelte-1i19ct2">Enter the 6-digit code from your app to confirm setup:</label> <input id="totp-verify" type="text" placeholder="000000" maxlength="6" pattern="[0-9]*" inputmode="numeric" autocomplete="one-time-code" class="totp-input svelte-1i19ct2" required/> <div class="button-row svelte-1i19ct2"><button type="submit" class="btn btn-primary svelte-1i19ct2"> </button> <button type="button" class="btn btn-secondary svelte-1i19ct2">Cancel</button></div></form></div>`),ot=A('<div class="totp-status enabled svelte-1i19ct2"><span class="status-badge svelte-1i19ct2">Enabled</span> <p class="svelte-1i19ct2">Two-factor authentication is active on your account.</p> <button class="btn btn-danger svelte-1i19ct2"> </button></div>'),lt=A('<div class="totp-status disabled svelte-1i19ct2"><span class="status-badge off svelte-1i19ct2">Not enabled</span> <p class="svelte-1i19ct2">Protect your account with a time-based one-time password.</p> <button class="btn btn-primary svelte-1i19ct2"> </button></div>'),nt=A('<div class="settings-container svelte-1i19ct2"><h1 class="svelte-1i19ct2">Settings</h1> <section class="settings-section svelte-1i19ct2"><h2 class="svelte-1i19ct2">Theme</h2> <p class="section-description svelte-1i19ct2">Choose your preferred color mode.</p> <div class="theme-switch svelte-1i19ct2"><label class="svelte-1i19ct2"><input type="radio" name="theme" value="light"/> Light</label> <label class="svelte-1i19ct2"><input type="radio" name="theme" value="dark"/> Dark</label> <label class="svelte-1i19ct2"><input type="radio" name="theme" value="system"/> System</label></div></section> <!> <!> <section class="settings-section svelte-1i19ct2"><h2 class="svelte-1i19ct2">Password</h2> <p class="section-description svelte-1i19ct2"><!></p> <form class="password-form svelte-1i19ct2"><!> <label for="new-password" class="svelte-1i19ct2"> </label> <input id="new-password" type="password" required minlength="8" autocomplete="new-password" class="svelte-1i19ct2"/> <label for="confirm-password" class="svelte-1i19ct2">Confirm password</label> <input id="confirm-password" type="password" required minlength="8" autocomplete="new-password" class="svelte-1i19ct2"/> <button type="submit" class="btn btn-primary svelte-1i19ct2"> </button></form></section> <section class="settings-section svelte-1i19ct2"><h2 class="svelte-1i19ct2">Two-Factor Authentication (TOTP)</h2> <p class="section-description svelte-1i19ct2">Add an extra layer of security by requiring a code from your authenticator app when you sign in.</p> <!></section></div>');function gt(L,I){Ge(I,!0);const v=Ze();let r=P(!1),d=P(null),m=P(null),g=P(""),p=P(""),c=P(""),y=P(null),h=P(""),u=P("system");Re(()=>{a(u,et(),!0)});function U(e){const t=e.target.value;a(u,t,!0),$e(s(u))}He(()=>{!v.isLoading&&!v.isAuthenticated&&Xe("/auth/login")});async function he(){a(r,!0),a(d,null),a(m,null);try{a(y,await O.auth.setupTotp(),!0)}catch(e){a(d,e instanceof Error?e.message:"Failed to start TOTP setup",!0)}finally{a(r,!1)}}async function _e(e){e.preventDefault(),a(r,!0),a(d,null);try{await O.auth.verifyTotpSetup(s(h));const t=await O.auth.getMe();ee(t),a(y,null),a(h,""),a(m,"Two-factor authentication has been enabled.")}catch(t){a(d,t instanceof Error?t.message:"Invalid code",!0)}finally{a(r,!1)}}async function be(){a(r,!0),a(d,null),a(m,null);try{await O.auth.disableTotp();const e=await O.auth.getMe();ee(e),a(m,"Two-factor authentication has been disabled.")}catch(e){a(d,e instanceof Error?e.message:"Failed to disable TOTP",!0)}finally{a(r,!1)}}async function we(e){var t,n;if(e.preventDefault(),a(d,null),a(m,null),s(p).length<8){a(d,"Password must be at least 8 characters.");return}if(s(p)!==s(c)){a(d,"Passwords do not match.");return}a(r,!0);try{const b={new_password:s(p)};(t=v.user)!=null&&t.has_password&&(b.current_password=s(g)),await O.auth.setPassword(b);const x=await O.auth.getMe();ee(x),a(g,""),a(p,""),a(c,""),a(m,(n=v.user)!=null&&n.has_password?"Password has been changed.":"Password has been set. You can now sign in with email and password.",!0)}catch(b){a(d,b instanceof Error?b.message:"Failed to set password",!0)}finally{a(r,!1)}}function ge(){a(y,null),a(h,""),a(d,null)}var Y=nt();Ke("1i19ct2",e=>{Ve(()=>{We.title="Settings - Community Resilience"})});var j=o(i(Y),2),te=o(i(j),4),z=i(te),B=i(z);E(B),B.__change=U,Z(),l(z);var G=o(z,2),H=i(G);E(H),H.__change=U,Z(),l(G);var ae=o(G,2),Q=i(ae);E(Q),Q.__change=U,Z(),l(ae),l(te),l(j);var se=o(j,2);{var ye=e=>{var t=at(),n=i(t,!0);l(t),C(()=>k(n,s(d))),w(e,t)};M(se,e=>{s(d)&&e(ye)})}var re=o(se,2);{var Te=e=>{var t=st(),n=i(t,!0);l(t),C(()=>k(n,s(m))),w(e,t)};M(re,e=>{s(m)&&e(Te)})}var V=o(re,2),W=o(i(V),2),Pe=i(W);{var Se=e=>{var t=fe("Change your password for email/password sign-in.");w(e,t)},ke=e=>{var t=fe("Set a password to enable offline sign-in with your email and password.");w(e,t)};M(Pe,e=>{var t;(t=v.user)!=null&&t.has_password?e(Se):e(ke,!1)})}l(W);var J=o(W,2),ie=i(J);{var Ce=e=>{var t=rt(),n=o(me(t),2);E(n),C(()=>n.disabled=s(r)),F(n,()=>s(g),b=>a(g,b)),w(e,t)};M(ie,e=>{var t;(t=v.user)!=null&&t.has_password&&e(Ce)})}var K=o(ie,2),xe=i(K,!0);l(K);var q=o(K,2);E(q);var D=o(q,4);E(D);var X=o(D,2),Ee=i(X,!0);l(X),l(J),l(V);var oe=o(V,2),Oe=o(i(oe),4);{var Ae=e=>{var t=it(),n=o(i(t),2),b=i(n);tt(b,()=>s(y).qr_svg),l(n);var x=o(n,2),T=o(i(x),2),_=i(T,!0);l(T),l(x);var f=o(x,2),S=o(i(f),2);E(S);var le=o(S,2),R=i(le),qe=i(R,!0);l(R);var ne=o(R,2);ne.__click=ge,l(le),l(f),l(t),C(()=>{k(_,s(y).secret),S.disabled=s(r),R.disabled=s(r)||s(h).length<6,k(qe,s(r)?"Verifying...":"Enable TOTP"),ne.disabled=s(r)}),pe("submit",f,_e),F(S,()=>s(h),De=>a(h,De)),w(e,t)},Me=e=>{var t=Je(),n=me(t);{var b=T=>{var _=ot(),f=o(i(_),4);f.__click=be;var S=i(f,!0);l(f),l(_),C(()=>{f.disabled=s(r),k(S,s(r)?"Disabling...":"Disable TOTP")}),w(T,_)},x=T=>{var _=lt(),f=o(i(_),4);f.__click=he;var S=i(f,!0);l(f),l(_),C(()=>{f.disabled=s(r),k(S,s(r)?"Setting up...":"Set Up TOTP")}),w(T,_)};M(n,T=>{var _;(_=v.user)!=null&&_.totp_enabled?T(b):T(x,!1)},!0)}w(e,t)};M(Oe,e=>{s(y)?e(Ae):e(Me,!1)})}l(oe),l(Y),C(()=>{var e,t;$(B,s(u)==="light"),$(H,s(u)==="dark"),$(Q,s(u)==="system"),k(xe,(e=v.user)!=null&&e.has_password?"New password":"Password"),q.disabled=s(r),D.disabled=s(r),X.disabled=s(r)||s(p).length<8||s(p)!==s(c),k(Ee,s(r)?"Saving...":(t=v.user)!=null&&t.has_password?"Change Password":"Set Password")}),pe("submit",J,we),F(q,()=>s(p),e=>a(p,e)),F(D,()=>s(c),e=>a(c,e)),w(L,Y),Qe()}Be(["change","click"]);export{gt as component};
